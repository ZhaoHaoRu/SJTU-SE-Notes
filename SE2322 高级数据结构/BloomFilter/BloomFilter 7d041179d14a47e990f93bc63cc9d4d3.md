# BloomFilter

## 特点

• **一个元素如果判断结果为存在的时候元素不一定存在，但是判断结果为不存在的时候则一定不存在**。

• **布隆过滤器可以添加元素，但是不能删除元素**。因为删掉元素会导致误判率增加。

## 添加查询元素

- 对于n个哈希函数的一种选取：$h_i(x) = MD5(x + i)$

![Untitled](BloomFilter%207d041179d14a47e990f93bc63cc9d4d3/Untitled.png)

## 优缺点

### 优点

相比于其它的数据结构，布隆过滤器在空间和时间方面都有巨大的优势

- 布隆过滤器存储空间和插入/查询时间都是常数 O(K)
- 散列函数相互之间没有关系，方便由硬件并行实现
- 布隆过滤器不需要存储元素本身，在某些对保密要求非常严格的场合有优势

### 缺点

- 随着存入的元素数量增加，误报率随之增加 （false positive)
- 一般情况下不能从布隆过滤器中删除元素
- 查询效率弱
- 因为多个随机哈希函数探测的是bit数组中多个不同的点，所以会导致低CPU缓存命中率

## false positive 推导

![Untitled](BloomFilter%207d041179d14a47e990f93bc63cc9d4d3/Untitled%201.png)

放宽条件：认为此时只要是能查找到即为误报

**误报率为：**

![Untitled](BloomFilter%207d041179d14a47e990f93bc63cc9d4d3/Untitled%202.png)

给定m、n,选择k使得误报率最小（具体推导见笔记）：

![Untitled](BloomFilter%207d041179d14a47e990f93bc63cc9d4d3/Untitled%203.png)

给定m、n、k，false positive的概率最大为：

![Untitled](BloomFilter%207d041179d14a47e990f93bc63cc9d4d3/Untitled%204.png)

## 应用

- 数据库防止穿库。 Google Bigtable，HBase 和 Cassandra 以及 Postgresql 使用BloomFilter来减少不存在的行或列的磁盘查找。避免代价高昂的磁盘查找会大大提高数据库查询操作的性能。
- 业务场景中判断用户是否阅读过某视频或文章，比如抖音或头条，当然会导致一定的误判，但不会让用户看到重复的内容。
- 缓存宕机、缓存击穿场景，一般判断用户是否在缓存中，如果在则直接返回结果，不在则查询db，如果来一波冷数据，会导致缓存大量击穿，造成雪崩效应，这时候可以用布隆过滤器当缓存的索引，只有在布隆过滤器中，才去查询缓存，如果没查询到，则穿透到db。如果不在布隆器中，则直接返回。
- WEB拦截器，如果相同请求则拦截，防止重复被攻击。用户第一次请求，将请求参数放入布隆过滤器中，当第二次请求时，先判断请求参数是否被布隆过滤器命中。可以提高缓存命中率。Squid 网页代理缓存服务器在 cache digests中就使用了布隆过滤器。Google Chrome浏览器使用了布隆过滤器加速安全浏览服务
- Venti 文档存储系统也采用布隆过滤器来检测先前存储的数据。
- SPIN 模型检测器也使用布隆过滤器在大规模验证问题时跟踪可达状态空间